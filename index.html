<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão Pro - Painel Administrativo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
            min-height: 100vh;
        }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        .admin-gradient {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
        }

        .success-badge { background: linear-gradient(135deg, #10b981, #059669); }
        .pending-badge { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .blocked-badge { background: linear-gradient(135deg, #ef4444, #dc2626); }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        .animate-slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
    </style>
</head>
<body class="text-white antialiased">

    <!-- TELA DE LOGIN ADMIN -->
    <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-10 animate-slide-up">
            <div class="w-20 h-20 admin-gradient rounded-2xl mx-auto flex items-center justify-center shadow-lg mb-6">
                <i class="fas fa-crown text-white text-3xl"></i>
            </div>
            
            <h2 class="text-2xl font-black text-center mb-2">Painel Administrativo</h2>
            <p class="text-sm text-center text-gray-400 mb-8">Gestão Pro Enterprise</p>
            
            <div class="space-y-4">
                <input type="email" id="admin-email" 
                    class="w-full p-5 bg-white/10 border border-white/20 rounded-2xl text-center text-lg font-bold text-white placeholder-gray-500 focus:border-indigo-500 focus:bg-white/20 outline-none transition-all"
                    placeholder="E-mail administrativo">
                
                <input type="password" id="admin-password" 
                    class="w-full p-5 bg-white/10 border border-white/20 rounded-2xl text-center text-lg font-bold text-white placeholder-gray-500 focus:border-indigo-500 focus:bg-white/20 outline-none transition-all"
                    placeholder="Senha">

                <div id="login-error" class="hidden bg-red-500/20 border border-red-500/50 rounded-xl p-3 text-center">
                    <p class="text-xs text-red-300 font-bold">Credenciais inválidas</p>
                </div>
            </div>

            <button onclick="Admin.login()" 
                class="w-full mt-6 bg-indigo-600 hover:bg-indigo-500 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase text-xs tracking-[0.2em]">
                Acessar Painel
            </button>

            <div class="mt-6 text-center">
                <p class="text-[10px] text-gray-500 uppercase tracking-wider">
                    <i class="fas fa-shield-alt mr-1"></i>Acesso Restrito
                </p>
            </div>
        </div>
    </div>

    <!-- PAINEL PRINCIPAL -->
    <div id="admin-panel" class="hidden min-h-screen p-4 lg:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <div class="glass-panel p-6 mb-8 flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-4">
                    <div class="w-12 h-12 admin-gradient rounded-xl flex items-center justify-center shadow-lg">
                        <i class="fas fa-crown text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-black">Painel Administrativo</h1>
                        <p class="text-xs text-gray-400 uppercase tracking-wider">Gestão Pro Firebase</p>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <span id="admin-email-display" class="text-sm text-gray-400"></span>
                    <button onclick="Admin.logout()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-2 rounded-lg text-xs font-bold uppercase transition-all">
                        <i class="fas fa-power-off mr-2"></i>Sair
                    </button>
                </div>
            </div>

            <!-- Estatísticas -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="glass-panel p-6 text-center">
                    <p class="text-[10px] text-gray-400 uppercase mb-1">Total Licenças</p>
                    <p id="stat-total" class="text-3xl font-black text-white">0</p>
                </div>
                <div class="glass-panel p-6 text-center border-b-4 border-emerald-500">
                    <p class="text-[10px] text-emerald-400 uppercase mb-1">Ativos</p>
                    <p id="stat-active" class="text-3xl font-black text-emerald-400">0</p>
                </div>
                <div class="glass-panel p-6 text-center border-b-4 border-amber-500">
                    <p class="text-[10px] text-amber-400 uppercase mb-1">Pendentes</p>
                    <p id="stat-pending" class="text-3xl font-black text-amber-400">0</p>
                </div>
                <div class="glass-panel p-6 text-center border-b-4 border-red-500">
                    <p class="text-[10px] text-red-400 uppercase mb-1">Bloqueados</p>
                    <p id="stat-blocked" class="text-3xl font-black text-red-400">0</p>
                </div>
            </div>

            <!-- Adicionar Novo Usuário -->
            <div class="glass-panel p-8 mb-8">
                <h3 class="font-black text-sm uppercase mb-6 flex items-center gap-2 text-emerald-400">
                    <i class="fas fa-plus-circle"></i> Liberar Novo Acesso
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <input type="text" id="new-user-doc" class="bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-gray-500 focus:border-emerald-500 outline-none" placeholder="CPF ou CNPJ (somente números)">
                    <input type="text" id="new-user-name" class="bg-white/10 border border-white/20 rounded-xl p-4 text-white placeholder-gray-500 focus:border-emerald-500 outline-none" placeholder="Nome completo">
                    <select id="new-user-plan" class="bg-white/10 border border-white/20 rounded-xl p-4 text-white focus:border-emerald-500 outline-none">
                        <option value="30">Plano: 30 Dias</option>
                        <option value="90">Plano: 90 Dias</option>
                        <option value="365" selected>Plano: 365 Dias</option>
                        <option value="lifetime">Plano: Vitalício</option>
                    </select>
                    <button onclick="Admin.addUser()" class="bg-emerald-600 hover:bg-emerald-500 text-white font-black py-4 rounded-xl uppercase text-xs tracking-wider transition-all">
                        <i class="fas fa-check mr-2"></i>Liberar Acesso
                    </button>
                </div>
            </div>

            <!-- Lista de Usuários -->
            <div class="glass-panel p-6 mb-8">
                <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                    <h3 class="font-black text-sm uppercase flex items-center gap-2 text-indigo-400">
                        <i class="fas fa-users"></i> Usuários Cadastrados
                    </h3>
                    <div class="flex gap-3">
                        <input type="text" id="search-users" oninput="Admin.filterUsers()" class="bg-white/10 border border-white/20 rounded-lg px-4 py-2 text-sm text-white placeholder-gray-500 focus:border-indigo-500 outline-none" placeholder="Buscar por nome ou documento...">
                        <button onclick="Admin.refreshData()" class="bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-2 rounded-lg text-sm transition-all" title="Atualizar">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="text-gray-400 uppercase text-[10px] border-b border-white/10">
                            <tr>
                                <th class="text-left py-4 px-3">Status</th>
                                <th class="text-left py-4 px-3">Nome</th>
                                <th class="text-left py-4 px-3">Documento</th>
                                <th class="text-center py-4 px-3">Plano</th>
                                <th class="text-center py-4 px-3">Expiração</th>
                                <th class="text-center py-4 px-3">Último Acesso</th>
                                <th class="text-right py-4 px-3">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="users-list" class="divide-y divide-white/5">
                            <tr><td colspan="7" class="py-8 text-center text-gray-500">Carregando...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Logs de Acesso -->
            <div class="glass-panel p-6">
                <h3 class="font-black text-sm uppercase mb-4 flex items-center gap-2 text-amber-400">
                    <i class="fas fa-history"></i> Logs de Acesso Recentes
                </h3>
                <div id="access-logs" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-sm text-gray-500 italic">Nenhum log registrado</p>
                </div>
            </div>

        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // ==========================================
        // CONFIGURAÇÃO FIREBASE
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyCboQje-66ONNTe9OtmS-HxF7_7hmTAhg4",
            authDomain: "gestorpro-fda39.firebaseapp.com",
            projectId: "gestorpro-fda39",
            storageBucket: "gestorpro-fda39.firebasestorage.app",
            messagingSenderId: "614355486570",
            appId: "1:614355486570:web:ec1b6f76020cde55b68713",
            measurementId: "G-2MYNYCG3DW"
        };

        let app, auth, db;
        
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
            console.log('✅ Firebase Admin conectado!');
        } catch(e) {
            console.error('❌ Erro Firebase:', e);
            alert('Erro ao conectar ao Firebase. Verifique sua conexão.');
        }

        // ==========================================
        // SISTEMA ADMIN
        // ==========================================
        
        const Admin = {
            currentUser: null,
            allUsers: [],

            async login() {
                const email = document.getElementById('admin-email').value;
                const password = document.getElementById('admin-password').value;

                if (!email || !password) {
                    this.showError('Preencha e-mail e senha');
                    return;
                }

                try {
                    const cred = await auth.signInWithEmailAndPassword(email, password);
                    this.currentUser = cred.user;
                    this.showPanel();
                } catch(e) {
                    console.error(e);
                    this.showError('Credenciais inválidas ou sem permissão de acesso');
                }
            },

            showError(msg) {
                const div = document.getElementById('login-error');
                div.querySelector('p').textContent = msg;
                div.classList.remove('hidden');
            },

            showPanel() {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
                document.getElementById('admin-email-display').textContent = this.currentUser.email;
                
                this.loadData();
                this.loadLogs();
            },

            async loadData() {
                try {
                    const snap = await db.collection('licenses').orderBy('createdAt', 'desc').get();
                    this.allUsers = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    
                    this.renderStats();
                    this.renderUsers();
                } catch(e) {
                    console.error('Erro ao carregar:', e);
                    alert('Erro ao carregar dados. Verifique permissões.');
                }
            },

            renderStats() {
                const total = this.allUsers.length;
                const active = this.allUsers.filter(u => u.password && u.status !== 'blocked').length;
                const pending = this.allUsers.filter(u => !u.password && u.status !== 'blocked').length;
                const blocked = this.allUsers.filter(u => u.status === 'blocked').length;

                document.getElementById('stat-total').textContent = total;
                document.getElementById('stat-active').textContent = active;
                document.getElementById('stat-pending').textContent = pending;
                document.getElementById('stat-blocked').textContent = blocked;
            },

            renderUsers() {
                const tbody = document.getElementById('users-list');
                const search = document.getElementById('search-users')?.value.toLowerCase() || '';
                
                let users = this.allUsers;
                if (search) {
                    users = users.filter(u => 
                        (u.name || '').toLowerCase().includes(search) ||
                        u.id.includes(search)
                    );
                }

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" class="py-8 text-center text-gray-500">Nenhum usuário encontrado</td></tr>';
                    return;
                }

                tbody.innerHTML = users.map(u => {
                    let statusBadge = '';
                    if (u.status === 'blocked') {
                        statusBadge = '<span class="blocked-badge text-white text-[9px] px-2 py-1 rounded-full font-bold">BLOQUEADO</span>';
                    } else if (!u.password) {
                        statusBadge = '<span class="pending-badge text-white text-[9px] px-2 py-1 rounded-full font-bold">PENDENTE</span>';
                    } else {
                        statusBadge = '<span class="success-badge text-white text-[9px] px-2 py-1 rounded-full font-bold">ATIVO</span>';
                    }

                    const expiry = u.plan === 'lifetime' ? 'Nunca' : this.calcExpiry(u.createdAt, u.plan);
                    const lastAccess = u.lastAccess ? new Date(u.lastAccess.seconds * 1000).toLocaleString('pt-BR') : 'Nunca';

                    return `
                        <tr class="hover:bg-white/5 transition-colors">
                            <td class="py-4 px-3">${statusBadge}</td>
                            <td class="py-4 px-3 text-white font-bold">${u.name || 'Sem nome'}</td>
                            <td class="py-4 px-3 text-gray-400 font-mono text-xs">${this.formatDoc(u.id)}</td>
                            <td class="py-4 px-3 text-center text-gray-400">${u.plan === 'lifetime' ? 'Vitalício' : u.plan + ' dias'}</td>
                            <td class="py-4 px-3 text-center text-gray-400 text-xs">${expiry}</td>
                            <td class="py-4 px-3 text-center text-gray-400 text-xs">${lastAccess}</td>
                            <td class="py-4 px-3 text-right">
                                ${u.status !== 'blocked' ? 
                                    `<button onclick="Admin.blockUser('${u.id}')" class="text-amber-400 hover:text-amber-300 mr-3" title="Bloquear"><i class="fas fa-ban"></i></button>` :
                                    `<button onclick="Admin.unblockUser('${u.id}')" class="text-emerald-400 hover:text-emerald-300 mr-3" title="Desbloquear"><i class="fas fa-check"></i></button>`
                                }
                                <button onclick="Admin.resetPassword('${u.id}')" class="text-blue-400 hover:text-blue-300 mr-3" title="Resetar senha"><i class="fas fa-key"></i></button>
                                <button onclick="Admin.deleteUser('${u.id}')" class="text-red-400 hover:text-red-300" title="Excluir permanentemente"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('');
            },

            calcExpiry(created, plan) {
                if (!created || plan === 'lifetime') return 'N/A';
                
                let date;
                if (created.seconds) {
                    date = new Date(created.seconds * 1000);
                } else {
                    date = new Date(created);
                }
                
                date.setDate(date.getDate() + parseInt(plan));
                return date.toLocaleDateString('pt-BR');
            },

            formatDoc(doc) {
                if (doc.length === 11) {
                    return doc.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                }
                return doc.replace(/(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})/, '$1.$2.$3/$4-$5');
            },

            async addUser() {
                const doc = document.getElementById('new-user-doc').value.replace(/\D/g, '');
                const name = document.getElementById('new-user-name').value.trim();
                const plan = document.getElementById('new-user-plan').value;

                if (doc.length < 11 || !name) {
                    alert('Preencha CPF/CNPJ (mínimo 11 dígitos) e nome corretamente');
                    return;
                }

                try {
                    const existing = await db.collection('licenses').doc(doc).get();
                    if (existing.exists) {
                        alert('Este documento já está cadastrado!');
                        return;
                    }

                    await db.collection('licenses').doc(doc).set({
                        name: name,
                        plan: plan,
                        status: 'active',
                        password: null,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                        createdBy: this.currentUser?.email || 'admin'
                    });

                    // Limpa formulário
                    document.getElementById('new-user-doc').value = '';
                    document.getElementById('new-user-name').value = '';
                    
                    alert(`✅ Acesso liberado com sucesso!\n\nDocumento: ${this.formatDoc(doc)}\nNome: ${name}\nPlano: ${plan === 'lifetime' ? 'Vitalício' : plan + ' dias'}`);
                    
                    this.loadData();

                } catch(e) {
                    console.error(e);
                    alert('Erro ao liberar acesso: ' + e.message);
                }
            },

            async blockUser(doc) {
                if (!confirm('Bloquear este usuário? Ele perderá acesso imediatamente ao sistema.')) return;
                
                try {
                    await db.collection('licenses').doc(doc).update({ 
                        status: 'blocked',
                        blockedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        blockedBy: this.currentUser?.email
                    });
                    this.loadData();
                } catch(e) {
                    alert('Erro ao bloquear: ' + e.message);
                }
            },

            async unblockUser(doc) {
                if (!confirm('Desbloquear este usuário?')) return;
                
                try {
                    await db.collection('licenses').doc(doc).update({ 
                        status: 'active',
                        unblockedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    this.loadData();
                } catch(e) {
                    alert('Erro ao desbloquear: ' + e.message);
                }
            },

            async resetPassword(doc) {
                if (!confirm('Resetar senha? O usuário precisará criar nova senha no próximo acesso.')) return;
                
                try {
                    await db.collection('licenses').doc(doc).update({ 
                        password: null,
                        resetAt: firebase.firestore.FieldValue.serverTimestamp(),
                        resetBy: this.currentUser?.email
                    });
                    
                    // Copia documento para área de transferência
                    const formatted = this.formatDoc(doc);
                    navigator.clipboard.writeText(formatted).then(() => {
                        alert(`✅ Senha resetada!\n\nDocumento ${formatted} copiado para área de transferência.\n\nO usuário criará nova senha no próximo acesso.`);
                    });
                    
                    this.loadData();
                } catch(e) {
                    alert('Erro ao resetar: ' + e.message);
                }
            },

            async deleteUser(doc) {
                if (!confirm('⚠️ EXCLUIR PERMANENTEMENTE?\n\nEsta ação não pode ser desfeita! O usuário perderá todos os dados.')) return;
                
                if (!confirm('Tem certeza absoluta? Digite SIM para confirmar.')) return;
                
                try {
                    await db.collection('licenses').doc(doc).delete();
                    this.loadData();
                    alert('Usuário excluído permanentemente.');
                } catch(e) {
                    alert('Erro ao excluir: ' + e.message);
                }
            },

            filterUsers() {
                this.renderUsers();
            },

            refreshData() {
                this.loadData();
            },

            loadLogs() {
                // Logs são armazenados no Firebase para persistência entre dispositivos
                db.collection('access_logs').orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                    const logs = snap.docs.map(d => d.data());
                    this.renderLogs(logs);
                }, err => {
                    console.log('Sem acesso a logs em tempo real:', err);
                    // Fallback para logs locais se não tiver permissão
                    const localLogs = JSON.parse(localStorage.getItem('GP_ACCESS_LOGS') || '[]');
                    this.renderLogs(localLogs);
                });
            },

            renderLogs(logs) {
                const container = document.getElementById('access-logs');
                
                if (logs.length === 0) {
                    container.innerHTML = '<p class="text-sm text-gray-500 italic">Nenhum log registrado</p>';
                    return;
                }

                container.innerHTML = logs.slice(0, 20).map(log => {
                    const date = log.timestamp ? 
                        (log.timestamp.seconds ? new Date(log.timestamp.seconds * 1000) : new Date(log.timestamp)) : 
                        new Date();
                    
                    return `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg ${log.status !== 'success' ? 'border-l-2 border-red-500' : ''}">
                            <div>
                                <span class="text-gray-400 text-[10px]">${date.toLocaleString('pt-BR')}</span>
                                <p class="text-white text-xs font-bold">${this.formatDoc(log.doc || log.userDoc || '---')}</p>
                                ${log.userName ? `<p class="text-gray-500 text-[10px]">${log.userName}</p>` : ''}
                            </div>
                            <span class="text-[10px] ${log.status === 'success' ? 'text-emerald-400' : log.status === 'blocked' ? 'text-red-400' : 'text-amber-400'} uppercase font-bold">
                                ${log.status || 'unknown'}
                            </span>
                        </div>
                    `;
                }).join('');
            },

            logout() {
                auth.signOut();
                location.reload();
            }
        };

        // Verifica sessão existente
        auth.onAuthStateChanged(user => {
            if (user) {
                Admin.currentUser = user;
                Admin.showPanel();
            }
        });

        // Expõe global
        window.Admin = Admin;
    </script>
</body>
</html>
